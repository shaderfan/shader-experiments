package;

import away3d.containers.*;
import away3d.entities.*;
import away3d.materials.*;
import away3d.primitives.*;
import away3d.utils.*;
import away3d.primitives.SphereGeometry;
//import away3d.materials.ColorMaterial;
import away3d.core.base.data.Face;
import away3d.core.base.SubGeometry;
import away3d.core.base.Geometry;

import openfl.display.*;
import openfl.events.*;
import openfl.geom.Vector3D;
import openfl.Lib.getTimer;
import openfl.Vector;

import DiffuseMaterial;

class Diffuse extends Sprite {
  //engine variables
  private var _view:View3D;
  
  //scene objects
  private var _plane:Mesh;

  private var sphere:Mesh;

  private var triangle:Mesh;

  private var thn:Int;
  private var now:Int;
  private var amt:Int;
  
  /**
   * Constructor
   */
  public function new() {
    super();
    
    stage.scaleMode = StageScaleMode.NO_SCALE;
    stage.align = StageAlign.TOP_LEFT;
    
    //setup the view
    _view = new View3D();
    addChild(_view);
    
    //setup the camera
    _view.camera.z = -600;
    _view.camera.y = 500;
    _view.camera.lookAt(new Vector3D());
    
    //setup the scene
    /*
    _plane = new Mesh(new PlaneGeometry(700, 700), new TextureMaterial(Cast.bitmapTexture("assets/floor_diffuse.jpg")));
    _view.scene.addChild(_plane);
    */

    /*
    sphere = new Mesh(
      new SphereGeometry(100,8,8),
      new DiffuseMaterial()
    );

    _view.scene.addChild(sphere);
    */

    var sub = new SubGeometry();
    sub.autoDeriveVertexNormals = true;
    sub.autoDeriveVertexTangents = true;
    sub.autoGenerateDummyUVs = true;

    var v = new Vector<Float>();

    v.push(250.0);
    v.push(-250.0);
    v.push(0.0);

    v.push(-250.0);
    v.push(-250.0);
    v.push(0.0);

    v.push(0.0);
    v.push(250.0);
    v.push(0.0);

    sub.updateVertexData(v);

    var w = new Vector<Int>();
    w.push(0);
    w.push(1);
    w.push(2);

    sub.updateIndexData(w);

    var geometry = new Geometry();
    geometry.addSubGeometry(sub);

    triangle = new Mesh(
      geometry, 
      new DiffuseMaterial()
    );

    _view.scene.addChild(triangle);

    addChild(new away3d.debug.AwayStats(_view));

    thn = getTimer();
    amt = 0;
    
    //setup the render loop
    addEventListener(Event.ENTER_FRAME, _onEnterFrame);
    stage.addEventListener(Event.RESIZE, onResize);
    onResize();
  }
  
  /**
   * render loop
   */
  private function _onEnterFrame(e:Event):Void {
    now = getTimer();
    amt += now - thn;
    thn = now;
    while(amt >= 16) {
      //triangle.rotationY += 1;
      amt -= 16;
    }
    
    _view.render();
  }
  
  /**
   * stage listener for resize events
   */
  private function onResize(event:Event = null):Void
  {
    _view.width = stage.stageWidth;
    _view.height = stage.stageHeight;
  }
}
